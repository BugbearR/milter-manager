2008-12-15  Kouhei Sutou  <kou@cozmixng.org>

	* binding/ruby/src/toolkit/rb-milter-core-private.c
	(rb_milter__rval2macros): use rb_iterate() and rb_each() instead
	of rb_block_call().

	* binding/ruby/src/toolkit/rb-milter-compat.[ch]: fix return type
	of rb_milter_compat_inspect().

	* binding/ruby/src/toolkit/rb-milter-compat.[ch]: add fallback
	RBG_INSPECT.

	* binding/ruby/src/toolkit/rb-milter-compat.[ch]: add.

	* src/milter-manager.c: define fallback RUBY_INIT_STACK.

	* configure.ac: intltool >= 0.35.0.

	* milter/core/milter-reply-decoder.c (decode_reply_reply_code):
	initialize variable by NULL.

	* binding/ruby/src/toolkit/rb-milter-core-private.h: move to
	backward compatibility macros to ...
	* binding/ruby/src/toolkit/rb-milter.h: ... here.

2008-12-15  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* module/configuration/ruby/milter-manager-ruby-configuration.c: Do
	not use G_DEFINE_DYNAMIC_TYPE.
	* milter/core/milter-utils.[ch]: Added milter_utils_strcmp0.
	* milter/core/milter-header.c: Use milter_utils_strcmp0 instead of
	g_strcmp0.
	* milter/manager/milter-manager-children.c: Do not use
	g_queue_clear().
	* milter/client/milter-client-context.c: Use milter_utils_timeout_add
	instead of g_timeout_add_seconds.
	* milter/core/milter-utils.c: Use g_string_vprintf instead of
	g_string_append_vprintf.
	* milter/core/milter-utils.c: Do not use g_string_vprintf too.
	* milter/manager/milter-manager-children.c: Do not use g_queue_init.
	* bindings/ruby/src/toolkit/rb-milter-core-private.h: Workaround for
	agey Ruby-GNOME2.

2008-12-13  Kouhei Sutou  <kou@cozmixng.org>

	* test/manager/test-controller.c (setup_input_io): fix too many
	unreference bug.

	* data/applicable-conditions/Makefile.am (conditions_DATA): remove
	nonexistent entry.

2008-12-12  Kouhei Sutou  <kou@cozmixng.org>

	* binding/ruby/lib/milter/manager.rb: improve error handling.

	* binding/ruby/lib/milter/manager.rb,
	binding/ruby/test/manager/test-custom-xml-loader.rb: support XML
	serialized enabled parsing.

	* binding/ruby/test/manager/: follow the recent changes.

	* data/applicable-conditions/disable.conf: remove needless file.

	* milter/manager/milter-manager-configuration.c,
	test/manager/test-configuration.c: use egg's enabled.

	* milter/manager/milter-manager-egg.c
	(milter_manager_egg_to_xml_string): use
	milter_utils_xml_append_boolean_element().

	* milter/core/milter-utils.[ch], test/core/test-utils.c:
	add milter_utils_xml_append_boolean_element().

	* milter/manager/milter-manager-egg.[ch],
	test/manager/test-egg.c, test/manager/test-configuration.c: add
	enabled to egg.

	* TODO: add an entry:
	fix FIXME in data/applicable-conditions/remote-network.conf.

	* data/applicable-conditions/remote-network.conf: add FIXME.

	* TODO: add an entry: don't handle log event in Ruby/GLib.

	* binding/ruby/lib/milter/manager.rb,
	binding/ruby/test/manager/test-configuration-loader.rb: egg and
	applicable condition definition merge existing item and replace it.

	* binding/ruby/test/manager/test-egg.rb: add tests for description.

	* milter/manager/milter-manager-egg.[ch], test/manager/test-egg.c:
	add description to egg.

	* binding/ruby/src/manager/rb-milter-manager-egg.c,
	binding/ruby/test/manager/test-egg.rb: bind merge or egg.

	* milter/manager/milter-manager-egg.c, test/manager/test-egg.c:
	merge missing user name.

	* binding/ruby/src/manager/rb-milter-manager-applicable-condition.c,
	binding/ruby/test/manager/test-applicable-condition.rb: bind
	merge of applicable condition.

	* milter/manager/milter-manager-egg.[ch], test/manager/test-egg.c:
	implement merge.

	* milter/manager/milter-manager-applicable-condition.[ch],
	test/manager/test-applicable-condition.c: implement merge.

	* binding/ruby/src/manager/rb-milter-manager-configuration.c,
	binding/ruby/test/manager/test-configuration.rb: bind
	egg related functions.

	* test/lib/milter-manager-test-utils.[ch],
	test/lib/milter-test-utils.[ch],
	test/manager/test-configuration.c,
	test/manager/test-egg.c:
	milter_test_equal_manager_applicable_condition() ->
	milter_manager_test_applicable_condition_equal().

	* milter/manager/milter-manager-configuration.[ch],
	test/lib/milter-manager-test-utils.[ch],
	test/manager/test-configuration.c: add egg operation functions
	into configuration.

	* tool/milter-log-tool.rb: use current directory as default output
	directory.

2008-12-12  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* tool/milter-log-tool.rb: Cleanup output_graph.
	* tool/milter-log-tool.rb: Added --no-update-db option.
	* tool/milter-log-tool.rb: Show vertical label in graph.
	* tool/milter-log-tool.rb: Show update time in title label.
	* tool/milter-log-tool.rb: Show milter number on pass child graph.
	* milter/client/milter-client-context.c: Output quarantine statistics
	log.

2008-12-11  Kouhei Sutou  <kou@cozmixng.org>

	* milter/client/milter-client-context.c (quit_response): emit finished.

	* binding/ruby/lib/milter/manager.rb: all? -> any?.

	* data/applicable-conditions/disable.conf: add.

	* binding/ruby/lib/milter/manager.rb: use
	MilterManagerApplicableCondition.

	* binding/ruby/test/manager/test-configuration-loader.rb,
	binding/ruby/test/manager/test-custom-xml-loader.rb: follow the
	recent changes.

	* binding/ruby/src/manager/rb-milter-manager-configuration.c,
	binding/ruby/test/manager/test-configuration.rb: bind find and remove.

	* milter/manager/milter-manager-configuration.[ch],
	test/manager/test-configuration.c: add
	milter_manager_configuration_find_applicable_condition().

	* test/fixtures/leader/body-accept.txt,
	test/manager/test-leader.c: ensure waiting expected n-responses.

	* test/fixtures/leader/no-body-flag-on-both-client.txt: omit this
	scenario.

	* test/manager/test-leader.c: use 'emitted' not 'waiting'.

	* test/manager/test-manager.c: ensure killing hatched process.

	* test/manager/test-manager.c: add connect() check.

	* milter/manager/milter-manager-configuration.[ch],
	test/manager/test-configuration.c: add removing applicable
	condition API.

2008-12-11  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* tool/milter-log-tool.rb: Create state distinct RRD for passed
	filter.
	* milter/manager/milter-manager-children.c: Reply "continue" even if
	the rest milters does not demand the command on connect, helo,
	envelope-from, envelope-recipient, header and body state because when
	a milter which demands the command passes the command on "check-XX"
	signal, the rest milter should go on session.
	* tool/milter-log-tool.rb: Output filter pass graph.
	* milter/core/milter-utils.[ch]: Added
	milter_utils_get_enum_nick_name.
	* milter/server/milter-server-context.c: Use nick name for pass state.
	* tool/milter-log-tool.rb: "continue" on end-of-message mail is a
	normal mail not all mails so need to stack its bar on rejected mail.
	* tool/milter-log-tool.rb: Separate mail status RRD file.
	* milter/client/milter-client-context.c: Use nick name for reply to
	MTA.
	* tool/milter-log-tool.rb: Added MilterMailStatusLog class.
	* tool/milter-log-tool.rb: Added MilterRRDCount class.
	* tool/milter-log-tool.rb: Create new MilterRRDData class.
	* tool/milter-log-tool.rb: Cleanup MilterRRDCount class.
	* tool/milter-log-tool.rb: Added MilterRRD class. Also fix
	MilterRRDCount accessor method.
	* tool/milter-log-tool.rb: MilterMailStatusLog#count moved to
	MilterRRD#count.
	* tool/milter-log-tool.rb: MilterMailStatusLog -> MilterMailStatusRRD.
	* tool/milter-log-tool.rb: Added MilterPassChildRRD class.
	* tool/milter-log-tool.rb: Added MilterSessionRRD class.
	* tool/milter-log-tool.rb: cleanup create_rdd.
	* tool/milter-log-tool.rb: Added accept mail count.
	* tool/milter-log-tool.rb: Define @items for status, state or
	whatever.
	* tool/milter-log-tool.rb: Cleanup update_db.

2008-12-10  Kouhei Sutou  <kou@cozmixng.org>

	* milter/manager/milter-manager-applicable-condition.[ch],
	milter/manager/milter-manager-egg.c, test/manager/test-egg.c: call
	attach-to on hatched.

	* milter/manager/milter-manager-configuration.c,
	test/manager/test-configuration.c: add applicable condition to XML.

	* binding/ruby/src/manager/rb-milter-manager-egg.c,
	binding/ruby/test/manager/test-egg.rb: bind
	egg's applicable condition.

	* binding/ruby/src/manager/rb-milter-manager-configuration.c,
	binding/ruby/test/manager/test-configuration.rb: bind
	configuration's applicable condition.

	* milter/manager/milter-manager-configuration.[ch],
	test/lib/milter-test-utils.[ch],
	test/manager/test-configuration.c: support applicable condition.

	* binding/ruby/test/toolkit/test-server-context.rb:
	check-end-of-header is removed.

	* binding/ruby/test/toolkit/run-test.rb: remove.

	* binding/ruby/src/manager/rb-milter-manager-applicable-condition.c,
	binding/ruby/src/manager/rb-milter-manager.c,
	binding/ruby/src/manager/rb-milter-manager-private.h,
	binding/ruby/test/manager/test-applicable-condition.rb: bind
	applicable condition.

	* milter/manager/milter-manager-applicable-condition.c: make writable.

	* milter/manager/milter-manager-egg.[ch], test/manager/test-egg.c:
	support applicable condition.

	* milter/manager/milter-manager-applicable-condition.[ch],
	test/manager/test-applicable-condition.c: add.

	* milter/manager/milter-manager-children.c,
	milter/manager/milter-manager-configuration.[ch],
	test/manager/test-configuration.c:
	return_status_if_filter_unavailable -> fallback_status.

	* binding/ruby/lib/milter/manager.rb: fix wrong argument passing.

	* binding/ruby/lib/milter/manager.rb,
	binding/ruby/test/manager/test-custom-xml-loader.rb: support
	applicable condition loading and remove target configuration
	support.

2008-12-10  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* tool/milter-log-tool.rb: swap child and client sessions.
	* tool/milter-log-tool.rb: Do not output graph if RRD file does not
	exist.
	* tool/milter-log-tool.rb: Count correct normal mails.
	* tool/milter-log-tool.rb: Collect all status data for normal mails.
	* milter/manager/milter-manager-children.c: Invoke milter_statistics
	for end of filter process in expire_child to ensure output it.
	* milter/manager/milter-manager.c: Do not unref MilterManagerLeader in
	its signal callback function.
	* milter/manager/milter-manager-children.c: Emit "finished" signal in
	expire_child.
	* tool/milter-log-tool.rb: mail graph is a bar graph.
	* tool/milter-log-tool.rb: Use LINE instead of LINE1 or LINE2. LINE#
	represents its width.
	* tool/milter-log-tool.rb: Absent data should be "U" instead of 0. 
	* tool/milter-log-tool.rb: Output last update time into graph.
	* tool/milter-log-tool.rb: Separate session and mail data class.
	* tool/milter-log-tool.rb: Added MilterRRDCount class.
	* milter/server/milter-server-context.c: Remove needless
	"check-end-of-header" signal.
	* tool/milter-log-tool.rb: Collect passed filter data.

2008-12-09  Kouhei Sutou  <kou@cozmixng.org>

	* data/milter-manager.conf, data/applicable-conditions/,
	binding/ruby/lib/milter/manager.rb: support applicable condition
	definition in other files.

	* binding/ruby/src/manager/rb-milter-manager-configuration.c,
	binding/ruby/test/manager/test-configuration.rb: bind load path
	related functions.

	* milter/manager/milter-manager-configuration.[ch],
	test/manager/test-configuration.c: add
	milter_manager_configuration_get_load_paths().

	* TODO: add an entry for performance.

	* TODO: add graph types:
	- current working child milters.
	- # of all mails and rejected mails.

	* test/core/test-utils.c (test_append_index)
	(test_xml_append_text_element): write missing tests.

2008-12-09  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* tool/milter-log-tool.rb: Script to output graph.
	* tool/milter-log-tool.rb: Added start_time and end_time for graph.
	* tool/milter-log-tool.rb: Default start time of graph are 1hour for
	second, 12hour for minute, 24 hour for hour.
	* tool/milter-log-tool.rb: Added MilterGraphTimeSpan class.
	* milter/client/milter-client-context.c: Remove needless cast.
	* milter/client/milter-client-context.c: Output statistics log on each
	response.
	* tool/milter-log-tool.rb: Added rejected mails. Please remove old rrd
	file.
	* tool/milter-log-tool.rb: Separate graph.
	* tool/milter-log-tool.rb: 0 padding from last data.
	* milter/server/milter-server-context.c: Output statistics log on
	pass_state.
	* milter/server/milter-server-context.c: Use milter_debug instead of
	milter_info.
	* milter/core/milter-reply-decoder.c, milter/core/milter-reader.c,
	milter/client/milter-client.c, milter/client/milter-client-context.c:
	Use milter_debug instead of milter_info.
	* milter/manager/milter-manager-leader.c,
	milter/manager/milter-manager-child.c,
	milter/manager/milter-manager-children.c,
	milter/manager/milter-manager-main.c: Use milter_debug instead of
	milter_info.
	* milter/core/milter-syslog-logger.c: MILTER_LOG_LEVEL_STATISTICS is
	corresponding to LOG_INFO.

2008-12-08  Kouhei Sutou  <kou@cozmixng.org>

	* binding/ruby/lib/milter/manager.rb:
	- remove target_XXX.
	- use applicable conditions.

	* TODO: add some applicable condition ideas:
	- detected as spam (X-Spam-Flag:, X-Bogosity:)
	- detected as virus (X-Virus-Status:)

	* binding/ruby/lib/milter/manager.rb,
	binding/ruby/test/manager/test-configuration-loader.rb,
	binding/ruby/test/manager/test-configuration.rb,
	binding/ruby/test/manager/test-custom-xml-loader.rb: add
	ApplicableCondition.

	* TODO: add an entry: add default applicable conditions.

	* binding/ruby/src/manager/,
	binding/ruby/test/manager/test-configuration.rb:
	Milter::Manager::Configuration supports to-xml signal.

	* milter/manager/milter-manager-configuration.[ch],
	test/manager/test-configuration.c: support customized XML
	generation.

2008-12-08  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* milter/manager/milter-manager-children.c: Output "End of filter
	process ..." to log if time-out or error are occured.

2008-12-08  Kouhei Sutou  <kou@cozmixng.org>

	* binding/ruby/src/manager/rb-milter-manager-configuration.c: bind
	milter_manager_configuration_to_xml_string().

	* binding/ruby/test/manager/test-configuration-loader.rb: add.

	* binding/ruby/lib/milter/manager.rb: encode additional
	information value as YAML to keep Ruby object.

2008-12-05  Kouhei Sutou  <kou@cozmixng.org>

	* test/server/test-server-context.c: follow the recent change.

	* milter/manager/milter-manager.[ch],
	milter/manager/milter-manager-main.c, test/manager/test-manager.c:
	manager doesn't create configuration.

	* milter/manager/milter-manager-configuration.[ch],
	test/manager/test-configuration.c, test/manager/test-controller.c:
	add_load_path -> append_load_path and prepend_load_path.

	* milter/server/milter-server-context.c
	(milter_server_context_establish_connection): reduce duplicated
	error message generation.

	* milter/server/milter-server-context.c (connect_watch_func): fix
	an error message.

	* milter/manager/milter-manager-leader.c: fix wrong reply handling.

	* test/manager/test-manager.c (wait_for_manager_ready):
	timeout_waiting -> timeout_emitted.

2008-12-05  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* milter/client/milter-client.c, milter/manager/milter-manager.c:
	"Start session.." and "End of session.." moved to MilterManager.
	* milter/core/milter-syslog-logger.c: Do not output time value in
	syslog.
	* test/manager/test-manager.c (wair_for_manager_ready): Use
	non-blocking I/O.
	* milter/core/milter-syslog-logger.c: output time value only if log
	level is MILTER_LOG_LEVEL_STATISTICS.
	* milter/manager/milter-manager-children.c: Output pointer address of
	child to milter_statistics to identify each child.

2008-12-04  Kouhei Sutou  <kou@cozmixng.org>

	* milter/client/milter-client.c (process_client_channel): add FIXMEs.

	* tool/milter-test-client.c: handle SIGINT for terminating myself.

	* milter/core/milter-main.c (milter_init): initialize thread.

	* milter/client/milter-client.c (milter_client_main): use another
	main loop in a thread for accepting connection.

	* TODO: remove an entry: milter_manager_egg_to_xml_string()
	support target_XXX serialize.

	* test/client/test-client.c,
	test/client/test-client-context-header.c: add missing data signal
	handling.

	* test/manager/test-child.c: add a missing header.

	* binding/ruby/lib/milter/manager.rb: add target information to XML.

	* binding/ruby/src/manager/rb-milter-manager-egg.c,
	binding/ruby/test/manager/test-egg.rb: support XML customize.

	* milter/manager/milter-manager-egg.[ch], test/manager/test-egg.c:
	support XML customize.

	* data/milter-manager.conf: add sample configurations.

	* tool/milter-test-client.c (cb_data): add missing DATA logging.

	* binding/ruby/lib/milter/manager.rb: fix a wrong condition bug.

2008-12-04  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* test/manager/test-manager.c (wait_for_manager_ready): Check errno
	after invoking socket().
	* test/manager/test-manager.c: Send unknown command by default.
	* milter/manager/milter-manager-children.c: Set io channel encoding
	NULL to handle binary data correctly.
	* test/manager/test-leader.c: Added large body packet test. But
	received data is not checked yet.
	* test/manager/test-manager.c: Added check controller port test.
	* test/manager/test-manager.c (wait_for_manager_ready): Check errno
	after exiting timeout loop to inspect timeout cause.
	* milter/manager/milter-manager-child.[ch]: Added
	milter_manager_child_get_pid() for test. Also do not use WCOREDUMP
	since the macro is unable to use on SunOS, AIX etc.
	* test/manager/test-leader.c: Reduce large body size to avoid hang
	up.. I am not satisfied the size.
	* test/core/test-logger.c: console output test.
	* milter/client/milter-client.c: Added milter_statistics.
	* milter/client/milter-client.c: Output MilterClientContext address in
	milter_statistics.
	* milter/manager/milter-manager-children.c: Change message of start
	process.
	* milter/manager/milter-manager.c, milter/client/milter-client.c: To
	ensure that the last child outputs "End of filter process.." to log
	MilterManager should not unref the MilterManagerLeader object in
	cb_quit(). But the message ("End of filter..") is after ("End of
	session..") since MilterClient receives "finished" signal in
	MilterAgent. Fix it!
	* milter/manager/milter-manager.c: Fix the order of finished process
	in log. But "Invalid file descriptor." comes from somewhere.

2008-12-03  Kouhei Sutou  <kou@cozmixng.org>

	* TODO: add an entry: milter_manager_egg_to_xml_string() support
	target_XXX serialize.

	* binding/ruby/lib/milter/manager.rb: support
	/configuration/milters/milter/connection_spec parsing
	partially. Need TEST!!!

	* configure.ac: fix a typo.

	* binding/ruby/lib/milter/manager.rb: support
	/configuration/milters/milter parsing partially. Need TEST!!!

	* module/configuration/ruby/milter-manager-ruby-configuration.c:
	fix wrong method name bug.

	* milter/manager/milter-manager-configuration.c
	(milter_manager_configuration_to_xml_string): fix wrong value bug.

	* tool/milter-test-server.c: add --unknown command.

	* tool/milter-test-server.c: use sendmail compatible options.

	* tool/milter-test-server.c, test/tool/test-server.c, TODO:
	support --connect-host and --connect-address.

	* tool/milter-test-server.c, test/tool/test-server.c,
	test/tool/fixtures/parse-test.mail: add missing angles to path.

	* TODO: add: support extracting multiple {reverse,forward}-paths
	from envelope-from and envelope-recipient address in --mail-file.

	* tool/milter-test-server.c, test/tool/test-server.c,
	test/tool/fixtures/parse-test.mail: support path extraction from
	mail address.

	* tool/milter-test-server.c: add a missing space.

	* tool/milter-test-server.c, test/tool/fixtures/parse-test.mail:
	fix the last line of body handling.

	* tool/milter-test-server.c, test/tool/fixtures/parse-test.mail:
	fix header and body separation parsing.

	* TODO: update an entry: fix envelope-from and envelope-recipient
	address extracting in --mail-file.

	* milter/core/milter-utils.c, test/core/test-utils.c:
	milter_utils_get_flags_names() works for the first flags data
	correctly.

	* tool/milter-test-client.c: support received information output.

	* TODO: update an entry:
	  - delete: support outputting received information.
	  - add: support outputting reply information.

	* milter/core/milter-utils.[ch], test/core/test-utils.c: add
	milter_utils_get_flags_names().

	* src/Makefile.am (milter_manager_LDADD): add a missing dependency.

	* milter/core/milter-connection.[ch]:
	milter_connection_generate_spec_from_address() ->
	milter_connection_address_to_spec().
	* milter/client/milter-client.c, test/core/test-connection.c:
	follow the above change.

	* TODO: add an entry:
	- tool/milter-test-client:
	  - support outputting received information.
	  - support customizing reply by command line option.

	* tool/milter-test-client.c: use <glib/gi18n.h>.

	* TODO: add an entry:
	- tool/milter-test-server:
	  - support --connect-host=HOST
	  - support --connect-address=SPEC
	  - support --macro=CONTEXT:NAME:VALUE

	* tool/milter-test-server.c: cleanup options.
	* test/tool/test-server.c: follow the above change.

	* tool/milter-test-server.c: use milter_init() not g_type_init().

2008-12-03  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* milter/manager/milter-manager-children.c:
	get_first_command_waiting_child_queue ->
	get_first_child_in_command_waiting_child_queue.
	* milter/manager/milter-manager-children.c: Cleanup.
	Do not emit "continue" signal of MilterServerContext when "accept"
	reply is received by the child after the second child.
	* test/fixtures/manager/skip-on-body.txt: Start client2007 too.
	* milter/manager/milter-manager-children.c: Counting senting body is
	not needed because the process is done in MilterServerContext.
	* milter/manager/milter-manager-children.c
	(send_first_command_to_next_child): The first command should be a
	command that is needed for target child.
	* milter/manager/milter-manager-children.c: Send "continue" if the
	next command is not received yet.
	* milter/manager/milter-manager-leader.c,
	milter/server/milter-server-context.c: Support chain continuous
	"body" command.
	* milter/manager/milter-manager-children.c: Revert removal counting
	sending body cout.
	* test/manager/test-manager.c,
	test/fixture/leader/body-larger-than-milter-chunk-size.txt: Added a
	larger body test. But separated secondary chunk is not checked yet.
	* test/lib/milter-manager-test-client.c: > 4096 bytes packet support.
	* test/lib/milter-manager-test-client.c: Workaround for > 4096 bytes
	body chunk.
	* test/tool/fixtures/large.mail: Added 64kbytes over size mail. The
	test does not check its output yet.
	* tool/milter-test-client.c: Use MilterSyslogLogger.
	* tool/milter-test-client.c: Use MilterSyslogLogger only if verborse
	mode.
	* tool/milter-test-server.c: Support mail data from stdin.

2008-12-02  Kouhei Sutou  <kou@cozmixng.org>

	* milter/core/milter-utils.[ch], test/core/test-utils.c: add XML
	generation related functions.

	* milter/manager/milter-manager-egg.[ch],
	milter/manager/milter-manager-configuration.[ch],
	test/manager/test-configuration.c,
	test/manager/test-egg.c: add XML generation functions.

	* milter/server/milter-server-context.c
	(milter_server_context_establish_connection): don't use
	uninitialized errno.

	* milter/server/milter-server-context.c,
	test/server/test-server-context-signals.c: improve log message.

	* tool/milter-test-server.c: improve output format.

	* test/tool/test-server.c: follow the recent output format changes.

	* src/Makefile.am: add a missing dependency.

	* **/Makefile.am: cleanup.

	* test/fixtures/manager/, test/manager/test-manager.c,
	tool/milter-test-server.c: support "Finished in XXXsec.".

	* test/lib/milter-test-client.rb (MilterTestClient#valid_state):
	fix wrong condition.

	* tool/milter-test-server.c: report processed time.

	* tool/milter-test-server.c: use <glib/gi18n.h>.

	* test/lib/milter-test-client.rb: cleanup.

	* test/manager/test-manager.c (test_scenario): start manager ASAP.

2008-12-02  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* tool/milter-test-server.c (cb_reply_code): Reply status depends on
	reply code.
	* tool/milter-test-server.c: Send "unknown" command after
	"envelope-recipient".
	* milter/server/milter-server-command.c (cb_decoder_continue): Send
	"continue" even if UNKNOWN state.
	* test/lib/milter-test-client.rb: Return continue on "unknown" state.
	* milter/client/milter-client-context.c: Handle "unknown".
	* test/lib/milter-test-client.rb: unknown state is not invalid.
	* test/manager/test-manager.c: Ensure closing milter-manager.
	* milter/manager/milter-manager-logger.[ch]: Added.
	* milter/manager/milter-manger.c: Use MilterManagerLogger.
	* milter/manager/milter-manager-logger.[ch] ->
	milter/core/milter-system-logger.[ch]: Moved.
	* milter/core/milter-system-logger.[ch]: milter_system_logger_new()
	needs identity for log.
	* tool/milter-test-server.c: Use MilterSyslogLogger.
	* test/tool/test-server.c: Do not reply in abort session.
	* milter/manager/milter-manager-children.c (cb_accept): Send next
	command if current state is DATA, HEADER and END_OF_HEADER.
	* tool/milter-test-server.c (cb_reply_code): Continue session if
	"reply-code" is received.
	* milter/server/milter-server-context.c: Send "continue" only if
	process_body_count is zero on body state.

2008-12-01  Kouhei Sutou  <kou@cozmixng.org>

	* module/configuration/ruby/milter-manager-ruby-configuration.c,
	binding/ruby/lib/milter/manager.rb,
	binding/ruby/test/manager/test-custom-xml-loader.rb: start custom
	configuration file loading support.

	* binding/ruby/test/milter-test-utils.rb,
	binding/ruby/test/run-test.rb: use RR.

	* binding/ruby/test/: MilterManagerEncoderTestUtils is needed.

	* milter/manager/milter-manager-configuration.[ch]: use other
	logic for custom configuration file loading.

	* binding/ruby/test/: unify utility modules.

	* milter/manager/milter-manager-controller.[ch],
	milter/manager/milter-manager-main.c,
	test/manager/test-controller.c: MilterManagerController has
	MilterManager not MilterManagerConfiguration.

	* milter/manager/milter-manager-configuration.[ch]
	(milter_manager_configuration_clear_load_paths): add.

	* milter/manager/: make MilterManager.

	* milter/client.h, milter/client/milter-client.c: make connection
	spec customizable.

	* milter/manager/milter-manager-controller.c: connect to
	get-status command.

	* test/core/test-utils.c: gtype -> type.

	* TODO: remove an entry: merge marshal.list.

	* milter/manager/: use milter/core/milter-marshalers.h.

	* TODO: remove an entry: improve log format.

	* milter/core/milter-logger.[ch]: support colorized logging.

	* milter/core/milter-utils.[ch], test/core/test-utils.c: add
	milter_utils_enum_from_string().

	* milter/core/milter-logger.[ch]: make logged tag customizable.

	* milter/core/milter-logger.c
	(milter_log_level_flags_from_string): use
	milter_utils_flags_from_string().

	* milter/core/milter-utils.[ch], test/core/test-utils.c: add
	milter_utils_flags_from_string().

2008-12-01  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* test/manager/test-manager.c: Add reject on evenelope-recipient test.
	* milter/manager/milter-manager-leader.c (milter_manager_leader_body):
	Increment sent_body_count just before milter_server_context_body().
	* milter/manager/milter-manager-leader.c (milter_manager_leader_body):
	If the first child had already returned "skip" reply, just send
	"continue" to MTA without sending "body" command to the first child.
	* tool/milter-test-server.c (cb_skip): If "skip" is received, send
	next command to milter-manger. But actually milter-manager does never
	receive "skip" reply because milter-manager should receive all body
	chunks for other children even if the first child returns "skip". This
	behaviour makes performance worse.
	* milter/server/milter-server-context.c (cb_decoder_skip): Check
	current state is body.
	* milter/manager/milter-manager-children.c (cb_skip): state check is
	done in MilterServerContext.
	* milter/manager/milter-manager-leader.c (cb_error): Reply
	"temporary-failure".
	* milter/manager/milter-manager-children.c: Cleanup. Remove needless
	value.
	* milter/server/milter-server-context.c: Cleanup, remove needless
	value.
	* milter/server/milter-server-context.c: Output MilterServerContext
	name to log.
	* milter/core/milter-utils.[ch]: Added milter_utils_get_enum_name().
	* milter/server/milter-server-context.c: Use
	milter_utils_get_enum_name to reduce log size.
	* milter/manager/milter-manager-leader.c (cb_error): Do nothing if
	error domain is not MILTER_MANAGER_CHILDREN_ERROR.
	* tool/milter-test-server.c (cb_reply_code): Invoke cb_reject(). 

2008-11-28  Kouhei Sutou  <kou@cozmixng.org>

	* binding/ruby/src/toolkit/rb-milter-private.h: add missing
	declaration.

	* test/manager/test-manager.c: add missing <signal.h>.

	* binding/ruby/src/toolkit/rb-milter-socket-address.c: plug a warning.

2008-11-28  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* milter/Makefile.am: added core, client and server to SUBDIRS.
	* Makefile.am: Added libmilter to SUBDIRS.
	* binding/ruby/test/run-test.rb: Fix load path.
	* test/manager/test-children.c, test/manager/test-configuration.c,
	test/manager/test-controller.c, test/manager/test-leader.c: Use
	milter_test_get_base_dir() instead of
	milter_manager_test_get_base_dir().
	* test/manager/Makefile.am: addded libmilter_test_utils.la to LIBS.
	* test/manager/test-manager.c: Added.
	* test/lib/milter-manager-test-utils.[ch]: Remove
	milter_manager_test_get_base_dir().
	* test/lib/milter-manager-test-client.c: Use
	milter_test_get_base_dir().
	* milter/manager/milter-manager.c: Show program name.
	* test/manager/test-manager.c: Added scenario framework. Also run
	milter-test-server.
	* test/manager/test-manager.c: g_strfreev() expects NULL teminated
	array.
	* test/manager/test-manager.c: Starting milter-test-server after
	milter-manager is ready.
	* milter/manager/milter-manager-children.[ch]: If all milters do not
	response on negotiation, emit
	MILTER_MANAGER_CHILDREN_ERROR_NO_NEGOTIATION_RESPONSE.
	Also do not invoke milter_manager_child_start() if no privilege mode.
	* test/manager/test-children.c: Added test_no_negotiation.
	* milter/manager/milter-manager-leader.c (cb_error): if all milters do
	not response on negotiation, send "reject".
	* test/manager/test-manager.c: wait for server reaping.
	* test/manager/test-manager.c: Added a scenario.
	* tool/milter-test-server.c: If "reject" is received on
	envelope-recipient, continure processing.

2008-11-27  Kouhei Sutou  <kou@cozmixng.org>

	* TODO: add entries:
	- write unit test for libmilter.
	- add --disable-milter-manager configure option.
	- add --disable-ruby configure option.

	* binding/ruby/src/manager/Makefile.am,
	milter/manager/Makefile.am, module/configuration/ruby/Makefile.am:
	fix include path.

	* ./: merge milter-toolkit and milter-manager.

	* milter/manager/milter-manager-control-protocol.h,
	milter/manager/milter-manager-control-reply-encoder.[ch],
	test/manager/test-control-reply-encoder.c: implement status reply encode.

	* test/manager/test-configuration.c (setup): ensure remove tmp dir.

	* test/manager/test-children.c: still FIXME...

	* test/lib/milter-manager-test-client.[ch]:
	- add milter_manager_test_clients_collect_all_macros().
	- clear defined macros in each clear_data()!

	* test/lib/milter-manager-test-client.[ch],
	test/lib/milter-test-client.rb: support define-macro.

	* test/lib/milter-manager-test-utils.[ch]
	(milter_manager_test_defined_macros_inspect,
	milter_manager_test_defined_macros_equal): add.

2008-11-27  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* milter/manager/milter-manager-children.[ch]: Added
	milter_manager_children_define_macro().
	* milter/manager/milter-manager-leader.[ch]: Added
	milter_manager_leader_define_macro().
	* test/lib/milter-manager-test-client.[ch]: Added
	getter of define-macro.
	* milter/manager/milter-manager.c: Handle "define-macro" signal from
	MilterClientContext.
	* test/lib/milter-manager-test-client.[ch]: Added
	milter_manager_test_clients_collect_macros.
	* test/lib/milter-manager-test-client.c: Unref macro hash table in
	dispose() not clear_data().
	* test/lib/milter-manager-test-client.c: Macro list data should be a
	MilterManagerTestPair.
	* test/lib/milter-manager-test-scenario.[ch]: Added
	milter_manager_test_scenario_get_pair_list_without_sort().
	* test/manager/test-leader.c: Check macro on "connect".
	* test/fixtures/leader/connect-with-macro.txt: Remove braces from
	macro name.
	* milter/manager/milter-manager-configuration.[ch]: Added
	manager_connection_spec.
	* bindings/ruby/lib/milter/manager.rb: Added manager.connection_spec
	settings.
	* milter/manager/milter-manager.c: Use manager.connection_spec value
	in milter-manager.conf.
	* milter/manager/milter-manager.c: Added --spec option.
	* milter/manager/milter-manager.c: spec from option is prior to the
	one in configuration.

2008-11-26  Kouhei Sutou  <kou@cozmixng.org>

	* milter/manager/milter-manager-control-command-decoder.c
	(decode_get_status),
	test/manager/test-control-command-decoder.c: implement.

	* milter/manager/milter-manager-control-command-encoder.c
	(milter_manager_control_command_encoder_encode_get_status),
	test/manager/test-control-command-encoder.c
	(test_encode_get_status): add.

	* binding/ruby/test/Makefile.am: add missing files.

	* binding/ruby/test/test-control-{reply,command}-encoder.rb:
	follow the below change.

	* milter/manager/milter-manager-control-command-encoder.c,
	milter/manager/milter-manager-control-command-decoder.c,
	milter/manager/milter-manager-control-reply-encoder.c,
	milter/manager/milter-manager-control-reply-decoder.c,
	milter/manager/milter-manager-control-protocol.h,
	test/milter/manager/test-control-*.c: use long command name.

2008-11-26  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* milter/manager/milter-manager-children.c: Invoke milter_statistics
	on both at first and last of child life.
	* milter/manager/milter-manager.c (milter_manager_main): Output error
	message if milter_client_main() fails.
	* milter/manager/milter-manager.c: Fail if invalid spec is specified.
	* milter/manager/milter-manager.c: Output error message on "error"
	signal of MilterClient.
	* milter/manager/milter-manager-children.c: copy header to
	original_headers in "end-of-message" instead of "end-of-header"
	because some milter set MILTER_STEP_NO_END_OF_HEADER flag.
	* milter/manager/milter-manager-leader.c
	(milter_manager_leader_end_of_message):  Set new state to
	END_OF_MESSAGE if the current_state is XX_REPLIED.
	* milter/manager/milter-manager-children.c: Initialize
	process_header_index with 0 in "end-of-message" command.
	* milter/manager/milter-manager-children.c: Do not store some command
	in command_queue.
	* milter/manager/milter-manager-children.c: Also initialize
	processing_header_index with 0 before sending "end-of-message" to next
	child.

2008-11-25  Kouhei Sutou  <kou@cozmixng.org>

	* ui/www/milter-manager-admin/: move to new path.

	* ui/www/milter-manager-admin/: add CRUD for config/milters/.

	* ui/www/milter-manager-admin/: setup testing environment.

	* ui/www/milter-manager-admin/: add /config/milters/.

	* ui/www/milter-manager-admin/: add an admin interface skeleton.

2008-11-23  Kouhei Sutou  <kou@cozmixng.org>

	* test/manager/test-controller.c: fix memory management.

	* test/run-test.sh: support valgrind.

	* milter/manager/milter-manager-configuration.c
	(milter_manager_configuration_load): fix a memory leak.

2008-11-21  Kouhei Sutou  <kou@cozmixng.org>

	* test/: gcut_io_channel_string_new() -> gcut_string_io_channel_new().

	* test/manager/test-controller.c,
	milter/manager/milter-manager-control-command-decoder.c: support reload.

2008-11-21  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* milter/manager/milter-manager-children.c: Emit "delete-header".
	* milter/manager/milter-manager-leader.c: Handle "delete-header"
	signal.

2008-11-20  Kouhei Sutou  <kou@cozmixng.org>

	* milter/manager/milter-manager-control-command-encoder.c,
	test/manager/test-control-command-encoder.c: support reload encode.

	* test/manager/test-controller.c: check reply.

	* test/manager/test-controller.c: cleanup.

2008-11-20  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* milter/manager/milter-manager-children.c: Handle "delete-header"
	signal.
	* test/lib/milter-test-client.rb: Added "--delete-header" option.

2008-11-20  Kouhei Sutou  <kou@cozmixng.org>

	* milter/manager/milter-manager-controller.c,
	test/manager/test-controller.c: implement set-configuration command.

	* milter/manager/milter/manager/milter-manager-configuration.[ch],
	test/manager/test-configuration.c: add
	milter_manager_configuration_save_custom().

	* milter/manager/milter/manager/milter-manager-configuration.[ch],
	module/configuration/ruby/milter-manager-ruby-configuration.c:
	load path is managed in parent configuration class.

	* binding/ruby/lib/milter/manager.rb,
	milter/manager/milter-manager.c, test/manager/test-leader.c:
	follow the above changes.

	* milter/manager/milter-manager-configuration.[ch],
	test/manager/test-configuration.c: add
	milter_manager_configuration_clear().

2008-11-19  Kouhei Sutou  <kou@cozmixng.org>

	* milter/manager/milter-manager-controller.c: follow the recent
	changes.

	* binding/ruby/src/rb-milter-manager-control-decoder.c,
	binding/ruby/src/rb-milter-manager-private.h,
	binding/ruby/src/rb-milter-manager.c,
	binding/ruby/test/test-control-command-decoder.rb,
	binding/ruby/test/test-control-reply-decoder.rb: add
	Milter::Manager::ControlCommandDecoder and
	Milter::Manager::ControlReplyDecoder.

	* binding/ruby/src/rb-milter-manager-control-reply-encoder.c,
	binding/ruby/src/rb-milter-manager-private.h,
	binding/ruby/src/rb-milter-manager.c,
	binding/ruby/test/test-control-reply-encoder.rb: add
	Milter::Manager::ControlReplyEncoder.

	* binding/ruby/src/rb-milter-manager-control-command-encoder.c,
	binding/ruby/src/rb-milter-manager-private.h,
	binding/ruby/src/rb-milter-manager.c,
	binding/ruby/test/test-control-command-encoder.rb,
	binding/ruby/test/milter-manager-encoder-test-utils.rb: add
	Milter::Manager::ControlCommandEncoder.

	* milter/manager/milter-manager-control-reply-{en,de}coder.[ch],
	test/manager/test-control-command-{en,de}coder.c: import -> set.

	* milter/manager/milter-manager-control-reply-encoder.[ch],
	test/manager/test-control-reply-encoder.c: support failure, error
	and configuration.

	* milter/manager/milter-manager-control-reply-encoder.[ch],
	test/manager/test-control-reply-encoder.c: add
	MilterManagerControlReplyEncoder.

	* test/manager/test-control-reply-decoder.c: add a test for
	unknown reply is received.

	* milter/manager/milter-manager-control-reply-decoder.[ch],
	test/manager/test-control-reply-decoder.c: support configuration.

	* milter/manager/milter-manager-control-reply-decoder.[ch],
	test/manager/test-control-reply-decoder.c: support failure and error.

	* milter/manager/milter-manager-control-reply-decoder.[ch],
	test/manager/test-control-reply-decoder.c: add
	MilterManagerControlReplyDecoder.

	* milter/manager/milter-manager-control-command-decoder.c,
	milter/manager/milter-manager-control-command-encoder.c,
	milter/manager/milter-manager-control-protocol.h:
	- MILTER_MANAGER_CONTROL_PROTOCOL_COMMAND_XXX ->
	  MILTER_MANAGER_CONTROL_COMMAND_XXX

	* milter/manager/, test/:
	control-{decoder,encoder} -> control-command-{decoder,encoder}.

	* milter/manager/milter-manager-control-encoder.[ch],
	test/manager/test-control-encoder.c: add.

	* milter/manager/milter-manager-control-decoder.h: cleanup includes.

	* test/manager/test-children.c: cleanup includes.

2008-11-19  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* milter/tools/milter-manager-test-milter.c: Added.
	* milter/manager/milter-manager-headers.[ch]: Removed.
	* milter/manager/milter-manager-children.c,
	test/manager/test-leader.c, test/lib/milter-manager-test-server.[ch],
	test/lib/milter-manager-test-scenario.c: Use MilterHeaders instead
	of MilterManagerHeaders.

2008-11-18  Kouhei Sutou  <kou@cozmixng.org>

	* test/
	- mail -> envelope-from.
	- rcpt -> envelope-recipient.

	* milter/manager/milter-manager-children.c,
	test/manager/test-children.c, test/manager/test-leader.c:
	- MAIL -> ENVELOPE_FROM.
	- RCPT -> ENVELOPE_RECIPIENT.

	* test/lib/milter-test-client.rb: use Milter::ReplyEncoder not
	Milter::Encoder.

	* ./: handler -> agent.

2008-11-18  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* milter/manager/milter-manager-children.c
	(get_first_command_waiting_child_queue): Emit "continue" signal if the
	first child in waiting queue does not need the command because if
	there is no response (i.e. continue or so), MTA does not send a next
	command.
	* test/lib/milter-test-client.rb: Added "--negotiate-flags" option.
	Return the option which has modified in milter-test-client.rb. Also
	the step of the return option is always the value which is set with
	"--negotiate-flags".
	* test/fixtures/leader/negotiate.txt: Set various steps of negotiate
	option.
	* milter/manager/milter-manager-children.c (state_to_command): Set
	server context state before emit "continue" signal.
	* test/manager/test-leader.c: Connect "xx-response" signal before
	sending each command. Also add "no_command_received" option in
	scenario file.
	* test/fixtures/leader/no-body-flag.txt: Added.
	* test/fixtures/leader/*.txt: Added "no_command_received" option if
	"n_recieved = 0" exists.
	* milter/manager/milter-manager-children.[ch]: Emit error even if all milters send
	MILTER_STEP_NO_XX flag and the command is sent.
	* milter/manager/milter-manager-children.c: Check the command can be
	sent before sending the command.
	* milter/manager/milter-manager-children.[ch]: Emit error if all
	milters are already dead.
	* test/fixtures/leader/*.txt: Check
	MILTER_MANAGER_CHILDREN_ERROR_NO_ALIVE_MILTER error.
	Hmm, "no_command_received" option is not used any more..
	* test/manager/test-leader.c (assert_response_common): Remove
	"no_command_received".
	(assert_have_response_helper): Remove should_timeout argument.
	* milter/manager/milter-manager-children.c (get_next_command): Skip
	command which is set to STEP_NO_XX on negotiation.

2008-11-17  Kouhei Sutou  <kou@cozmixng.org>

	* binding/ruby/lib/milter/manager.rb, data/milter-manager.conf:
	support control connection.

	* milter/manager/milter-manager.c: accept control
	connection. (only accept)

	* milter/manager/milter-manager-controller.[ch]: add.

	* milter/manager/milter-manager-configuration.[ch]: add control
	connection spec configuration.

	* test/manager/test-leader.c (do_connect),
	test/manager/test-children.c (do_connect),
	test/manager/test-egg.c (test_connection_spec_error),
	milter/manager/milter-manager-egg.c
	(milter_manager_egg_set_connection_spec): follow the recent
	milter-toolkit changes.

	* milter/manager.h,
	milter/manager/milter-manager-control-decoder.[ch],
	milter/manager/milter-manager-control-protocol.h,
	test/manager/test-control-decoder.c: add milter manager control
	protocol decoder.

	* test/manager/test-leader.c (do_end_of_message),
	test/fixtures/leader/: checked received chunks.

	* test/manager/test-leader.c (do_unknown),
	test/fixtures/leader/unknown.txt: check received unknown commands.

	* ./: controller -> leader.

	* test/manager/test-children.c (test_writing_timeout): wait
	continue signal.

2008-11-17  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* milter/manager/milter-manager-children.c (cb_temporary-failure):
	Emit "temporay-failure" signal while processing END-OF-MESSAGE.
	* milter/manager/milter-manager-children.c (cb_skip): Send a next
	command if END-OF-MESSAGE has been already sent.
	* milter/manager/milter-manager-children.c (cb_skip): Cleanup. Move to
	the next of cb_accept().
	* milter/manager/milter-manager-children.c
	(test_end_of_message_timeout): Set end-of-message timeout zero only
	for the first client.
	* test/fixtures/controller/end-of-message-replaced-body: The second
	client does not reject on BODY and check replaced body chunks on
	END-OF-MESSAGE.
	* milter/manager/milter-manager-headers.[ch]: Added
	milter_manager_headers_length().
	* milter/manager/milter-manager-headers.[ch]: Added
	milter_manager_headers_get_nth_header().
	* milter/manager/milter-manager-headers.c
	(milter_manager_headers_get_nth_header): THe index begins from 1 not
	0.
	* test/lib/milter-manager-test-scenario.c
	(milter_manager_test_scenario_get_pair_list): Set name NULL.
	* test/manager/test-leader.c (do_header): Sort header list before
	assert check.
	* milter/manager/milter-manager-children.c: HEADER command is sent to
	a child sequential to END-OF-MESSAGE command.
	* milter/manager/milter-manager-children.c: DATA command is sent to
	a child sequential to END-OF-MESSAGE command.
	* milter/manager/milter-manager-headers.[ch]: Added
	milter_manager_headers_copy().
	* milter/manager/milter-manager-children.c: Preserve orignal header
	list. TODO: Emit appropiriate xx-header signals when all children
	completed the process.
	* milter/manager/milter-manager-headers.[ch]: Added
	milter_manager_headers_lookup_by_name().
	* milter/manager/milter-manager-headers.[ch]: Added
	milter_manager_headers_find().
	* milter/manager/milter-manager-headers.[ch]: Added
	milter_manager_headers_remove().
	* milter/manager/milter-manager-headers.c
	(milter_manager_headers_change_header): Added a new header if the
	index is greater then the number of headers which has the targert
	name.
	* milter/manager/milter-manager-headers.[ch]: Added
	milter_manager_headers_index_in_same_header_name().
	* milter/manager/milter/manager-children.c: Emit "add-header",
	"insert-header" and "change-header" before the last "end-of-message"
	signal.
	* test/manager/test-leaders.c: Unified "xx-header" signal tests.
	* test/lib/milater-manager-test-scenario.c: Use MilterManagerHeader
	instead of MilterManagerTestHeader.
	* test/lib/milter-manager-test-server.[ch]: Use MilterManagerHeader.
	* milter/manager/milter-manager-children.c
	(emit_signals_on_end_of_message): Remove found header from processing
	list if change-header is emitted.
	* test/lib/milter-manager-test-server.[ch]: Added
	milter_manager_test_server_add_header() to a header on "HEADER"
	command.
	* test/manager/test-leader.c (do_header): Invoke
	milter_manager_test_server_add_header() expicitly.
	* test/lib/milter-manager-test-utis.[ch]: Remove
	MilterManagerTestHeader.

2008-11-16  Kouhei Sutou  <kou@cozmixng.org>

	* test/manager/test-children.c (assert_response_common): wait
	until signal emitted.

	* test/manager/test-controller.c (assert_response_common): wait
	received end-of-message output.

2008-11-14  Kouhei Sutou  <kou@cozmixng.org>

	* test/manager/test-children.c: write a test for writing timeout.

	* test/manager/test-children.c,
	test/fixtures/children/header.txt: rewrite
	end-of-header test as scenario based test.

	* test/manager/test-children.c,
	test/fixtures/children/header.txt: rewrite
	header test as scenario based test.

	* test/manager/test-children.c,
	test/fixtures/children/data.txt: rewrite
	data test as scenario based test.

2008-11-14  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* milter/manager/milter-manager-children.c: Send "BODY" imediately if
	the target child is the first one.
	* test/manager/test-controller.c (do_body): Check response and chunks.
	* test/fixtures/controller/end-of-message-discard.txt,
	test/fixtures/controller/end-of-message-reject.txt,
	test/fixtures/controller/end-of-message-temporary-failure.txt:
	n_received is 1 on end-of-message response because no more process for
	the message if a child returns "REJECT", "DISCARD" or
	"TEMPORARY-FAILURE".
	* test/fixtures/controller/body.txt,
	test/fixtures/controller/body-accept.txt: Check chunk on each body
	command.
	* test/fixtures/controller/body-skip.txt,
	test/fixtures/controller/body-skip-all.txt: Check chunks on each body.
	But I am not sure each client is received correct chunks. I would like
	to write chunks[first-skip-client]=First skip message or something.
	* milter/manager/milter-manager-children.c (cb_finished): Do not
	invoke remove_child_from_queue() if current state is BODY and
	END_OF_MESSAGE.
	* milter/manager/milter-manager-children.c: command_queue ->
	command_waiting_child_queue.
	* milter/manager/milter-manager-children.c: Commands that from
	END-OF-HEADER to END-OF-MESSAGE are sent to a child sequentially.

2008-11-13  Kouhei Sutou  <kou@cozmixng.org>

	* test/manager/test-children.c,
	test/fixtures/children/envelope-recipient.txt: rewrite
	envelope-recipient test as scenario based test.

	* test/manager/test-children.c,
	test/fixtures/children/envelope-from.txt: rewrite envelope-from
	test as scenario based test.

	* test/manager/test-children.c,
	test/fixtures/children/helo.txt: rewrite helo test as
	scenario based test.

	* test/manager/test-children.c,
	test/fixtures/children/connect.txt: rewrite connect test as
	scenario based test.

	* test/manager/test-children.c,
	test/fixtures/children/negotiate-retry-fail.txt: rewrite retry
	failure on negotiate test as scenario based test.

	* milter/manager/milter-manager-headers.c: remove needless function.

	* test/lib/milter-manager-test-scenario.[ch]: support egg creation.

	* test/lib/milter-manager-test-client.[ch]
	(milter_manager_test_client_get_command): add.

	* test/manager/test-children.c,
	test/fixtures/children/negotiate-retry.txt: rewrite retry on
	negotiate test as scenario based test.

2008-11-13  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* milter/manager/milter-manager-children.c (send_body_to_child): NULL
	check of body_file. Also ref and unref for should_sent_body_milters.
	* milter/manager/milter/manager-children.c (send_body_to_child):
	Remove should_sent_body_milters before NULL check of body_file.
	* test/manager/test-children.c (test_end_of_message_timeout): wait
	until end-of-message-timeout signal is received.
	* test/lib/milter-test-client.rb: info_abort to get abort received
	status from MilterManagerTestClient.
	* test/fixtures/controller/abort.txt ->
	tetst/fixtures/controller/abort-on-end-of-message.txt: Renamed.
	* test/lib/milter-manager-test-scenario.c: Fix memory leak.
	* test/lib/milter-manager-test-client.[ch]: MilterManagerTestClient
	has its name. milter_manager_test_client_new() needs its name. Added
	milter_manager_test_client_find().
	* test/lib/milter-manager-test-client.[ch]: Added name getter.
	* test/lib/milter-manager-test-client.[ch]: Added
	milter_manager_test_client_wait_reply(). It just waits from a
	specified client.
	* test/lib/milter-manager-test-scenario.[ch]: Added
	milter_manager_test_scenario_get_locale_string().
	 The name should be change more appropriate name.
	* test/lib/milter-manager-test-scenario.[ch]: 
	milter_manager_test_scenario_get_locale_string() ->
	milter_manager_test_scenario_get_string_with_sub_key.
	Also add G_KEY_FILE_KEEP_TRANSLATIONS flag.
	* test/lib/milter-manager-test-client.c
	(milter_manager_test_client_wair_reply): reverse return value of
	getter.
	* test/manager/test-controller.c: Proof-of-concept of
	reponse[client10026] entry in scenario file. It is only enabled to be
	used in bort, need to be generalization.
	* milter/manager/milter-manager-headers.[ch]: Added.
	* milter/manager/milter-manager-children.c: Manage headers (not
	completed yet). 
	(cb_reject_code): Invoke cb_reject() at the end of the function.

2008-11-12  Kouhei Sutou  <kou@cozmixng.org>

	* test/lib/milter-manager-test-utils.[ch]
	(milter_manager_test_wait_signal): support timeout check.
	* test/manager/test-children.c, test/manager/test-controller.c:
	use milter_manager_test_wait_signal() with timeout check.

	* test/lib/milter-manager-test-server.[ch]
	(milter_manager_test_server_wait_signal): move to ...
	* test/lib/milter-manager-test-utils.[ch]
	(milter_manager_test_wait_signal): ... here.
	* test/manager/test-controller.c: use
	milter_manager_test_wait_signal() instead of
	milter_manager_test_server_wait_signal().

	* test/lib/milter-test-client.rb: support regular expression for
	chunk specification.

2008-11-12  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* fixtures/controller/body-accept.txt,
	fixtures/controller/body-skip.txt,
	fixtures/controller/body-skip-all.txt: "BODY" command now sends
	conjunct message at once. i.e. "First lineSecond line". So just send a
	"BODY" command for a while.
	* milter/manager/milter-manager-children.c: Now "BODY" chunks is sent
	on "END-OF-MESSAGE" command.  But "ERROR! - invalid state" message
	output here and threre.
	* test/manager/test-controller.c: Do not check response in body action
	since "BODY" command does not send chunks to milter until
	"END-OF-MESSAGE" command is sent. Also not clear test client data on
	body command.
	* milter/manager/milter-manager-children.[ch]: Added
	milter_manager_children_get_state().
	* milter/manager/milter-manager-children.c: Set current state to
	MILTER_MANAGER_CHILDREN_STATE_BODY before send body.
	* milter/manager/milter-manager-children.c (cb_continue): Do nothing
	if body state. Fix invalid state error.
	* milter/manager/milter-manager-children.[ch]: Now
	MilterManagerChildren has its state represented by
	MilterServerContextState. Also manage body and end-of-message queue
	with should_be_sent_body_milters list. But invalid state error
	reappears in "body accept" test.
	* milter/manager/milter-manager-children.c (remove_child_from_queue):
	Do not emit signal while BODY state.
	* milter/manager/milter-manager-children.c (cb_finished): Output
	state to log.
	* test/fixtures/controller/quit.txt: n_received of quit-response is 1
	since the first child has been quited in end-of-message state so
	quit-response is received only from the second child in
	milter-manager.
	* milter/manager/milter-manager-children.c: Replace body chunk if
	"REPLACE-BODY" reply is received and send the replaced body to the
	child. Changed test name, "replace separate" -> "replace overwrite".
	* milter/manager/milter-manager-children.c: Cleanup skip process.
	* test/manager/test-controller.c: Also check chunks in end-of-message.
	* test/fixtures/controller/body-skip-*.txt: check body response and
	chunks.
	* milter/manager/milter-manager-children.c: Preserve the chunk of
	END-OF-MESSAGE aside from body chunks.

2008-11-12  Kouhei Sutou  <kou@cozmixng.org>

	* test/manager/test-children.c,
	test/fixtures/children/negotiate.txt: add a initial but dirty
	scenario support.

	* test/fixtures/controller/negotiate.txt: remove a garbage.

2008-11-11  Kouhei Sutou  <kou@cozmixng.org>

	* milter/manager/milter-manager-children.c: fix reference count bug.

	* test/lib/milter-test-client.rb (MilterTestClient#read_packet):
	ignore EOF error.

	* test/manager/test-controller.c: 50 -> 100.

	* test/manager/test-controller.c: move scenario related codes to ...
	* test/lib/milter-manager-test-scenario.[ch],
	test/lib/milter-manager-test-client.[ch]: ... here.

2008-11-11  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* test/lib/milter-manager-test-client.c: Support multi-line response
	from milter-test-client.rb.
	* milter/manager/milter-manager-child.[ch]: Remove name property.
	* milter/manager/milter-manager-children.h: Added
	MilterManagerChildrenState.
	* milter/manager/milter-manager-children.[ch]: Preserve reply status
	for each MilterServerContextState.
	* milter/manager/milter-manager-controller.c: multipule body support.
	* milter/manager/milter-manager-controller.c: Do not set
	END_OF_MESSAGE state if the current state BODY.

2008-11-10  Kouhei Sutou  <kou@cozmixng.org>

	* test/manager/test-children.c: fix a memory leak.

	* test/manager/test-children.c,
	test/lib/milter-test-client.rb: fix timeout test. but not good yet...

	* test/lib/milter-manager-test-client.c: cleanup.

	* test/lib/milter-manager-test-client.[ch],
	test/manager/test-controller.c,
	test/fixtures/controller/negotiate.txt: checks all received
	negotiate option.

	* test/lib/milter-manager-test-client.[ch],
	test/lib/milter-test-client.rb, test/manager/test-controller.c:
	add received negotiate option check.

	* test/manager/test-controller.c,
	test/lib/milter-manager-test-client.[ch],
	test/fixtures/controller/connect.txt: add received connect info check.

2008-11-10  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* test/lib/milter-test-client.rb: Set @next_state :abort
	instead of :quit if no_response option is set since if :quit
	state is set, TCPServer loop exits before
	"end_of_message_timeout" signal is emitted.
	* milter/manager/milter-manager-egg.[ch]: Add timeout values should be
	 gdboule.
	* milter/manager/milter-manager-children.c (expire_all_children): copy
	priv->milters before expiring.
	* milter/manager/milter-manager-children.[ch]: Added
	milter_manager_children_set_retry_connect_time.

2008-11-10  Kouhei Sutou  <kou@cozmixng.org>

	* test/manager/test-controller.c,
	test/fixtures/controller/helo.txt: check all received FQDNs on helo.

	* test/manager/test-controller.c: remove needless variables.

	* test/manager/test-controller.c,
	test/fixtures/controller/envelope-from-accept-all.txt:
	rewrite a test for accept from all clients on envelope-from as
	scenario based test.

	* test/manager/test-controller.c,
	test/fixtures/controller/envelope-from-accept.txt:
	rewrite a test for accept on envelope-from as scenario
	based test.

	* test/manager/test-controller.c,
	test/fixtures/controller/envelope-from-reject-and-accept.txt:
	rewrite a test for reject and accept on envelope-from as scenario
	based test.

	* test/manager/test-controller.c,
	test/fixtures/controller/envelope-from-reject-and-discard.txt:
	rewrite a test for reject and discard on envelope-from as scenario
	based test.

2008-11-09  Kouhei Sutou  <kou@cozmixng.org>

	* test/manager/test-controller.c,
	test/fixtures/controller/envelope-from-discard.txt: rewrite a test
	for discard on envelope-from as scenario based test.

	* milter/manager/milter-manager-children.c,
	test/fixtures/controller/envelope-recipient-*.txt: discard is
	important status rather than reject even if it is received on
	envelope-recipient.

	* test/lib/milter-test-client.rb: add --insert-header,
	--change-header and --remove-header.

	* test/manager/test-controller.c: remove needless code.

2008-11-07  Kouhei Sutou  <kou@cozmixng.org>

	* test/manager/test-controller.c, test/fixtures/controller/*.txt:
	rewrite tests as scenario based test.

	* milter/manager/milter-manager-children.c: expires all children
	if children's reply status is reject.

	* test/manager/test-controller.c,
	test/fixtures/controller/envelope-recipient-accept*.txt:
	rewrite envelope-recipient received accept test as scenario based
	test.

	* test/manager/test-controller.c,
	test/fixtures/controller/envelope-recipient-reject.txt:
	rewrite envelope-recipient received reject test as scenario based
	test.

	* test/lib/milter-test-client.rb: more convenient.

	* test/manager/test-controller.c,
	test/fixtures/controller/envelope-recipient-temporary-failure-all.txt:
	rewrite envelope-recipient received temporary-failure from all
	clients test as scenario based test.

	* test/manager/test-controller.c: remove needless test.

	* test/lib/milter-manager-test-client.[ch]: add pair values
	collect function.

	* test/lib/milter-manager-test-utils.[ch]: cleanup.

	* test/manager/test-controller.c: remove needless test.

	* test/lib/milter-manager-test-client.[ch]: add string values
	collect function.
	* test/manager/test-controller.c, test/fixtures/controller/: use
	the above function.

	* test/manager/test-controller.c,
	test/fixtures/controller/body-accept.txt: rewrite
	body accept test as scenario based test.

	* test/manager/test-controller.c,
	test/fixtures/controller/body-skip-all.txt: rewrite
	body skipped by all clients test as scenario based test.

	* test/manager/test-controller.c,
	test/fixtures/controller/end-of-message-chunk.txt: rewrite
	end-of-message test as scenario based test.

	* test/manager/test-controller.c,
	test/fixtures/controller/progress.txt: rewrite
	progress test as scenario based test.

	* test/lib/milter-manager-test-server.[ch]: get_XXXed_YYYs ->
	get_received_XXX_YYYs.
	* test/manager/test-controller.c, test/fixtures/controller/:
	follow the above change.

2008-11-07  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* milter/manager/milter-manager-children.c: Send "NEGOTIATE" after "ready"
	signal from a child is received.
	test_retry_negotiate_failure() and test_reading_timeout() fail yet.
	* milter/manager/milter-manager-children.c: Cleanup negotiation code.
	All tests passes now. Handle "connection-timeout" of
	MilterServerContext.
	* milter/manager/milter-manager-children.c: Remove unused value
	(quarantine_readon).

2008-11-06  Kouhei Sutou  <kou@cozmixng.org>

	* test/manager/test-controller.c,
	test/fixtures/controller/replay-code-invalid.txt: rewrite
	invalid reply-code test as scenario based test.

	* test/lib/milter-manager-test-server.[ch]: reply_code -> replied_codes.

	* test/manager/test-controller.c,
	test/fixtures/controller/replay-code.txt: rewrite
	reply-code test as scenario based test.

	* test/manager/test-controller.c,
	test/fixtures/controller/replace-body-separate.txt: rewrite
	replace-body from two clients test as scenario based test.

	* test/lib/milter-manager-test-server.[ch]: replace -> replaced.

	* test/manager/test-controller.c,
	test/fixtures/controller/replace-body.txt: rewrite
	replace-body test as scenario based test.

	* test/lib/milter-manager-test-server.[ch]: delete -> deleted.

	* test/manager/test-controller.c,
	test/fixtures/controller/delete-recipient.txt: rewrite
	delete-recipient test as scenario based test.

	* test/lib/milter-test-client.rb, test/manager/test-children.c:
	add no-response action and use it.

	* test/lib/milter-manager-test-utils.[ch]: ValueWithParam -> Pair.

	* test/lib/milter-manager-test-server.[ch]: collect all values.

	* test/manager/test-controller.c,
	test/fixtures/controller/add-recipient.txt: rewrite add-recipient test
	as scenario based test.

	* test/manager/test-controller.c,
	test/fixtures/controller/change-from.txt: rewrite change-from test
	as scenario based test.

	* test/lib/milter-manager-test-server.[ch]: collect change-from
	data as hash table.

	* test/manager/test-controller.c,
	test/fixtures/controller/quarantine.txt: add a test for quarantine.

	* test/manager/test-controller.c: remove needless add-header test.

	* test/manager/test-controller.c,
	test/fixtures/controller/add-header.txt: add add-header test.

	* test/manager/test-child.c: ensure restoring the current locale.

	* test/lib/milter-test-client.rb: cleanup --reply-code.

	* test/lib/milter-test-client.rb: support more flexible actions in
	end-of-message.

	* test/lib/milter-test-client.rb: not Array!

2008-11-06  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* test/lib/milter-manager-test-utils.[ch]: added
	milter_manager_test_header_compare.
	* test/lib/milter-test-client.rb: Send progress on end-of-message
	anyway.
	* test/lib/milter-manager-test-server.[ch]: Replace body should be a
	GList.
	* test/lib/milter-test-client.rb: "reply-code" option.
	* milter/manager/milter-manager-children.c,
	milter/manager/milter-manager-controller.c: Return
	MILTER_STATUS_REJECT if "reply-code" is received.
	* test/lib/milter-test-client.rb: Do not override action if reply-code
	option is not set.
	* milter/manager/milter-manager-controller.c(cb_shutdown,
	cb_connection_failure): SHUTDOWN and CONNECTION_FAILURE are not sent
	from milter but Sendmail may use them so output message to log.
	* milter/manager/milter-manager-child.[ch]: Remove
	milter_manager_child_new_with_timeout.
	* milter/manager/milter-manager-children.c (cb_finished): Output
	message to log. 
	* test/manager/test-children.c: Added reading timeout test. The test
	sometimes fails maybe.

2008-11-05  Kouhei Sutou  <kou@cozmixng.org>

	* test/manager/test-controller.c, test/fixtures/controller/: use
	scenario based test for tests of quit, abort and unknown.

	* test/manager/test-controller.c, test/fixtures/controller/: split
	scenario.

	* test/lib/milter-manager-test-client.[ch]: support clearing data.

	* test/manager/test-controller.c,
	test/fixtures/controller/body-skip.txt,
	test/fixtures/controller/connect.txt: support nested import.

	* test/manager/test-controller.c,
	test/fixtures/controller/body-skip.txt,
	test/fixtures/controller/negotiate.txt: implement import.

	* test/manager/test-controller.c,
	test/fixtures/controller/body-skip.txt: add status test.

	* test/lib/milter-manager-test-client.[ch],
	test/lib/milter-test-client.rb: collect FQDN, envelope from and
	envelope recipient data.

	* test/manager/test-controller.c,
	test/fixtures/controller/body-skip.txt: add scenario based test.

	* test/lib/Makefile.am: set CUT_RELATIVE_PATH.

	* test/manager/test-controller.c, test/fixtures/controller/: use
	GKeyFile to create MilterOption.

	* test/lib/milter-test-client.rb: override.

	* test/lib/milter-test-client.rb: cleanup.

2008-11-05  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* test/lib/milter-manager-test-server.c: Use g_idle_add_full with
	G_PRIORITY_DEFAULT to wait for receiving signals.
	* test/manager/test-controller.c (test_body): Create its own test data
	structure.
	* test/manager/test-controller.c: Added add-header test. TODO: check
	header names and values.
	* test/lib/milter-manager-test-utils.[ch]: Added
	MilterManagerTestHeader struct.
	* test/lib/milter-manager-test-server.[ch]: Added
	milter_manager_test_server_get_headers.
	* test/lib/milter-manager-test-utils.[ch]: Added
	milter_manager_test_header_inspect.
	* test/lib/milter-manager-test-utils.[ch]: Added
	milter_manager_test_header_equal.
	* test/manager/test-controller.c: Check header name and value.
	* test/manager/test-controller.c: Send different header from
	test-client respectively.
	* test/lib/milter-manager-test-server.c: Preserve recipient and from.
	* test/manager/test-controller.c: Use
	milter_server_context_set_state() instead of
	milter_server_context_end_of_message().
	* test/lib/milter-manager-test-server.c: Accessors.
	* test/lib/milter-test-client.rb: "--envelope-from" option.
	* test/lib/milter-test-client.rb: "--change-from" option.
	* test/lib/milter-test-client.rb: "--delete-recipient" option.
	* test/lib/milter-manager-test-utils.[ch]: MilterManagerTestHeader has
	an index.
	* test/lib/milter-manager-test-utils.[ch]: Added
	MilterManagerTestValueWithParam.
	* test/lib/milter-test-client.rb: "--add-recipient" option.
	* milter/manager/milter-manager-children.c
	(child_negotiate_without_retry): Emit "negotiate-reply" if previous
	negotiation is established.

2008-11-04  Kouhei Sutou  <kou@cozmixng.org>

	* test/lib/milter-test-client.rb, test/manager/test-controller.c:
	support --add-header.

	* test/lib/milter-test-client.rb: add more info.

	* test/manager/test-controller.c (test_end_of_message_quarantine):
	use GCutStringIOChannel's pipe mode.

2008-11-04  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* milter/manager/milter-manager-controller.c (cb_reply_code): Handle
	error from milter_client_context_set_reply().
	* test/manager/test-controller.c: Added a test for accepting in body.
	* test/lib/milter-manager-test-sever.[ch]: Added a new object for MTA
	substitute. The test fails yet.
	* test/manager/test-controller.c: Work around for GCutStringIOChannel.
	* test/lib/milter-manager-test-server.[ch]: Added get_n_XXs accesors.
	* test/manager/test-controller.c: Set MilterOption to
	MilterManagerTestServer explicitly.

2008-11-03  Kouhei Sutou  <kou@cozmixng.org>

	* binding/ruby/lib/milter/manager.rb: fix inverted bug.

2008-11-02  Kouhei Sutou  <kou@cozmixng.org>

	* data/milter-manager.conf: comment out optional configuration.

	* binding/ruby/lib/milter/manager.rb: improve error report.

	* data/milter-manager.conf, binding/ruby/lib/milter/manager.rb:
	support milter filter.

	* binding/ruby/lib/milter/manager.rb, data/milter-manager.conf:
	improve configuration file format.

	* milter/manager/milter-manager-children.c: fix passed data.

	* milter/manager/milter-manager-children.c: fix object lifetime.

	* milter/manager/milter-manager-child.c: use WEXITSTATUS().

	* milter/manager/milter-manager-child.c: support G_SPAWN_SEARCH_PATH.

	* test/: use configuration file in test/fixtures/configuration/.

	* milter/manager/milter-manager-controller.c: fix children write
	result handling.

	* milter/manager/milter-manager.c (milter_manager_main): change
	default port number: 9999 -> 10025.

2008-10-31  Kouhei Sutou  <kou@cozmixng.org>

	* test/manager/test-controller.c: cleanup.

	* milter/manager/milter-manager-children.c,
	test/manager/test-children.c: remove needless quarantine.

	* test/lib/milter-test-client.rb,
	milter/manager/milter-manager-children.c,
	test/manager/test-controller.c: support quarantine.

	* test/lib/milter-test-client.rb: upcase!

	* ./: receipt -> recipient.

	* test/lib/milter-test-client.rb: fix typos.

2008-10-31  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* test/manager/test-controller.c (test_envelope_receipt_reject): Check
	REJECT status.
	* test/manager/test-controller.c (test_envelope_receipt_reject): Also
	check going on accept further command.
	* test/lib/milter-test-clienr.rb: In ENVELOPE_RECEIPT, REJECT status
	is just rejecting the current receipt address.
	* test/manager/test-controller.c: Added a test for discarding in
	ENVELOPE_RECEIPT.
	* test/manager/test-controller.c: Added a test for temporary failure in
	ENVELOPE_RECEIPT.
	* test/manager/test-controller.c: Added a test for accepting in
	ENVELOPE_RECEIPT.
	* test/manager/test-controller.c
	(test_envelope_receipt_temporary_failure): Also check going on accept
	further command.
	* test/manager/test-controller.c: Added a test for returning "ACCEPT"
	and "TEMPORARY FAILURE" and "DISCARD".
	* milter/manager/milter-manager-children.[ch]: Important status
	depends on the current MilterServerContextState.
	* test/manager/test-controller.c: Added a test for returning "ACCEPT"
	and "DISCARD" from each child respectively.
	* test/manager/test-controller.c: Added a test that both children
	returns "TEMPORARY FAILURE".
	* test/manager/test-controller.c: Added a test that both children
	returns "ACCEPT".
	* milter/manager/milter-manager-children.c: Do not send "QUIT" command
	to the child which returns "SKIP" status. "SKIP" status means just
	skip further BODY command, it should be received next other
	command(i.e. END_OF_MESSAGE by ordinary). The test fails yet.
	* test/lib/milter-test-server.rb: Added info_XX methods.
	* milter/manager/milter-manager-children.c,
	milter/manager/milter-manager-controller.c: Handle reply-code.

2008-10-30  Kouhei Sutou  <kou@cozmixng.org>

	* test/manager/test-controller.c: add a test for rejected from
	child. it's not completed. FIXME!!!

	* test/lib/milter-manager-test-client.[ch]
	(milter_manager_test_client_set_arguments): add.

	* test/lib/milter-test-client.rb: support action.

	* milter/manager/milter-manager-children.c,
	test/manager/test-children.c: add tests for
	milter_manager_children_is_important_status(). need more.

	* milter/manager/milter-manager-children.[ch]
	(milter_manager_children_is_important_status): export.

	* test/manager/test-children.c (test_connect_pass): add.

	* test/manager/test-children.c (test_connect): add.

	* test/manager/test-children.c (test_negotiate): cleanup.

	* test/manager/test-children.c: use MilterManagerTestClient.

	* test/lib/milter-manager-test-client.[ch]
	(milter_manager_test_clients_wait_reply)
	(milter_manager_test_clients_collect_n_received): add.

	* test/manager/test-controller.c: use the above functions.

	* test/lib/Makefile.am: make libmilter-manager-test.la shared library.

2008-10-30  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* test/manager/test-controller.c: Revert the last commit.
	* milter/manager/milter-manager-children.c (cb_finished): Emit reply
	status if the child is the last one.
	* milter/manager/milter-manager-children.c (cb_finished): Emit reply
	status only if the reply status is not MILTER_STATUS_NOT_CHANGE(i.e.
	reply status has been changed in MilterManagerChildren.)
	* test/manager/test-controller.c: Remove needless
	g_main_context_itration and wait "unknown-response".
	* milter/manager/milter-manager-children.c: Retry negotiation to a
	milter when restart a milter. TODO: the test is not implemented yet.
	* milter/manager/milter-manager-egg.[ch]: Added command_options
	property.
	* milter/manager/milter-manager-configuration.c: privilege mode is a
	property.
	* milter/manager/milter-manager-children.c (child_negotiate):
	Reinitialize error value with NULL before invoking
	milter_manager_child_start().
	* milter/manager/milter-manager-child.c: stdout and stderr of a milter
	to /dev/null.
	* test/manager/test-children.c (test_retry_negotiate): To kill
	milter-test-client.rb sends "QUIT" command because the process which
	was run	from MilterManagerChild cannot kill.
	* milter/manager/milter-manager-controller.c: Send QUIT command to
	milters if "mta-timeout" signal is received.
	* module/configuration/ruby/milter-manager-ruby-configuration.c: Use
	G_DEFINE_DYNAMIC_TYPE.
	* milter/manager/milter-manager-controller.c: g_signal_emit_by_name()
	does not need detail GQuark.
	* milter/manager/milter-manager-children.c: Fix typo.
	* test/manager/test-children.c: added test_connect_half_pass().
	* milter/manager/milter-manager-children.c
	(milter_manager_children_is_important_status): Return TRUE or FALSE.

2008-10-29  Kouhei Sutou  <kou@cozmixng.org>

	* test/manager/test-controller.c: use MilterManagerTestClient.
	* test/lib/milter-manager-test-client.[ch]: add missing features.

	* test/lib/milter-manager-test-client.[ch]: add.

	* test/manager/test-children.c: add a test for negotiate. TOO DUTY!!!

	* binding/ruby/test/: follow the recent changes.

	* test/manager/test-controller.c: improve reply waiting.

	* test/manager/test-controller.c: cleanup.

	* milter/manager/milter-manager-children.c,
	test/manager/test-children.c: append a child not prepend.

	* milter/manager/milter-manager-egg.[ch], test/manager/test-egg.c:
	add hatched signal.

	* milter/manager/milter-manager-child.h: MANAGER_TYPE -> TYPE_MANAGER.

2008-10-29  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* milter/manager/milter-manager-children.c: Initialize quitted_milters
	with NULL and the first element should be itself not priv->milters.
	* data/milter-manager.conf, test/manager/test-controller.c: A new baby
	was born.
	* test/manager/test-egg.c: Unset MILTER_LOG_LEVEL.
	* milter/manager/milter-manager-children.c: Remove from reply queue if
	timeout is occurred.
	* milter/manager/milter-manager-children.c (cb_skip, cb_quarantine):
	Remove reply queue if state check fails.
	* test/manager/test-controller.c (test_quit, test_abort,
	test_unknown): Invoke g_main_context_iteration until all pending
	events were processed.
	* milter/manager/milter-manager-children.c: If all children sends
	"SKIP", emit "skip" signal.
	* milter/manager/milter-manager-children.c (cb_reject, cb_discard):
	Send "QUIT" command to a filter.
	* milter/manager/milter-manager-children.c:
	MILTER_STATUS_TEMPORARY_FAILURE should be very weak because if a
	filter sends TEMPORARY FAILURE, drop the filter only. All the other
	filters should not be affected.
	* milter/manager/milter-manager-children.c:
	MILTER_STATUS_TEMPORARY_FAILURE is not a critical status.
	* milter/manager/milter-manager-children.c: Added
	compare_reply_status.
	* milter/manager/milter-manager-children.c: Handle QUARANTINE reply.
	* milter/manager/milter-manager-children.c (cb_reject, cb_discard):
	Remove the second call of quit_child().
	* milter/manager/milter-manager-children.c (cb_skip, cb_quarantine):
	Send "QUIT" command if state check fails.
	* milter/manager/milter-manager-children.c: Expire the child if error
	is received.
	* milter/manager/milter-manager-children.c (cb_skip, cb_quarantine):
	Emit reply signal even if state check fails.
	* test/manager/test-controller.c: Check the number of received reply.
	Initialize client_end_of_header_received with 0.
	* milter/manager/milter-manager-children.c: Receive "finished" signal
	from each child and remove it from reply queue.
	* emitable -> emittable.
	* milter_error_emittable_emit_error -> milter_error_emittable_emit.
	* milter/manager/milter-manager-childrenc.: Emit "finished" signal if
	all children have gone away!
	* milter/manager/milter-manager-controller.c: Emit "finished" signal
	when receiving "finished" signal from MilterManagerChildren.
	* milter/manager/milter-manager-children.c: Expire a child only if
	"finished" signal is received or time out error.
	* test/manager/test-controller.c (test_unknown): Also check "finished"
	signal is received.
	* test/manager/test-controller.c: Send quit command after abort
	command.

2008-10-28  Kouhei Sutou  <kou@cozmixng.org>

	* binding/ruby/, data/milter-manager.conf: use egg.

	* milter/manager/milter-manager-configuration.[ch]: use egg not child.

	* milter/manager/milter-egg.[ch], test/manager/test-egg.c: support
	connection spec and hatch.

	* milter/manager/milter-manager-children.[ch]:
	- add milter_manager_children_length().
	- don't unref child while signal callback. decoder owned by
	the unrefed child may be processing.

	* milter/manager/milter-manager-child.[ch]: add child's name accessors.

	* test/manager/test-controller.c: spawn -> egg.

	* ./: spawn -> egg.

	* binding/ruby/test/test_spawn.rb: add tests for accessors.

2008-10-28  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* milter/manager/milter-manager-configuration.[ch]: Remove timeout
	values since these values depend on filter.
	* milter/manager/milter-manager-children.c: Emit compiled reply signal
	when all filters have returned response.
	* milter/manager/milter-manager-children.c: Also added child to queue in
	body command.
	* milter/manager/milter-manager-children.c: If the status from a
	filter is "ACCEPT" or "REJECT" or "DISCARD", send "QUIT" command and
	remove the filter from children list.
	* milter/manager/milter-manager-children.c (cb_temporary_failure):
	expire the filter if the state is a connection-oriented routine (i.e.
	NEGOTIATE or CONNECT or HELO).
	* milter/manager/milter-manager-children.c (cb_reject): expire the
	filter except ENVELOPE_RECEIPT routine. In the case of
	ENVELOPE_RECEIPT, reject the receipt and continue the session.
	* milter/manager/milter-manager-children.c: milter_error if SKIP reply
	is received not in BODY. send BODY command if skip reply has not been
	received yet.
	* milter/manager/milter-manager-children.c: NEGOTIATE is not a
	connection-oriented routine, QUIT is the one of it.
	* milter/manager/milter-manager-children.c: Emit "skip" signal if all
	children are received "SKIP" reply.
	* milter/manager/milter-manager-children.c (compile_reply_status):
	MILTER_STATUS_CONTINUE < MILTER_STATUS_ACCEPT <
	MILTER_STATUS_TEMPORARY_FAILURE < MILTER_STATUS_DISCARD <
	MILTER_STATUS_REJECT.
	* milter/manager/milter-manager-children.c: "progress" and
	"quarantine" reply are only allowed in end of message session.
	* milter/manager/milter-manager-children.c: Unref MilterChild in
	teardown_server_context_signals.
	* milter/manager/milter-manager-children.c: Close connection to a
	filter if timeout is happend.
	* milter/manager/milter-manager-controller.c: Cleanup unused timeout
	codes.
	* test/manager/test-child.c: Set MILTER_LOG_LEVEL environment value to
	suppress milter's log output.

2008-10-27  Kouhei Sutou  <kou@cozmixng.org>

	* binding/ruby/test/: add.

	* binding/ruby/src/rb-milter-manager.c,
	binding/ruby/src/rb-milter-manager-spawn.c,
	binding/ruby/src/rb-milter-manager-private.h,
	binding/ruby/src/Makefile.am: add spawn.

	* milter/manager.h: add spawn.

	* milter/manager/milter-manager-spawn.[ch],
	test/manager/test-spawn.c: add command.

	* milter/manager/milter-manager-spawn.[ch],
	test/manager/test-spawn.c: add user name.

	* milter/manager/milter-manager-child.c (child_watch_func): cleanup.

	* test/manager/test-controller.c: remove debug code.

	* test/manager/test-spawn.c: add tests for timeout.

	* milter/manager/milter-manager-spawn.[ch],
	test/manager/test-spawn.c: add.

	* milter/manager/milter-manager-controller.c,
	test/lib/milter-test-client.rb,
	test/manager/test-controller.c: support unknown command.

	* milter/manager/milter-manager-controller.c,
	test/manager/test-controller.c: support abort command.

	* milter/manager/milter-manager-controller.c,
	test/manager/test-controller.c: support quit command.

	* milter/manager/milter-manager-controller.c,
	test/manager/test-controller.c: support end-of-message command.

	* milter/manager/milter-manager-children.c: end-of-message isn't
	affected by MILTER_STEP_NO_BODY.

	* test/lib/milter-test-client.rb: end-of-message signal may
	receive chunk.

	* test/manager/test-controller.c: handle all step.

	* test/lib/milter-test-server.rb
	(MilterTestServer#sender_address): return Milter::SocketAddress
	not packed string.

	* milter/manager/milter-manager-children.c
	(milter_manager_children_end_of_message): shorten.

2008-10-27  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* milter/manager/milter-manager-children.c: Merge each MilterOption
	from filter.
	* milter/manager/milter-manager-children.c: MilterManagerConfigration
	property.
	* milter/manager/milter-manager-controller.c: Remove
	MilterMacrosRequests from private values.
	* milter/manager/milter-manager-children.c: Emit "error" signal.
	* milter/manager/milter-manager-children.c: Emit "error" if the daemon
	of child filter could not be started.
	* milter/manager/milter-manager-children.c: Check each command is
	needed for a child filter before invoking the command.
	* milter/manager/milter-manager-children.c: Emit "negotiate-reply"
	signal when all children filters returns "negotiate-reply".
	* milter/manager/milter-manager-controller.c: Connect to "error" signal
	of MilterManagerChildren.
	* milter/manager/milter-manager-childrenc.c: Emit "negotiate-reply"
	with its own (i.e. merged or combined )MilterOption and
	MilterMacrosRequests. And milter_manager_children_negotiate() returns
	FALSE if a filter fails on negotiation.
	* milter/manager.h: Include milter-manager-children.h.
	* milter/manager/milter-manager-objects.h: Added.
	* milter/manager/milter-manager-configuration.h: Move typedef of
	MilterManagerConfiguration into milter-manager-objects.h.
	* milter/manager/milter-manager-children.[ch]:
	milter_manager_children_new() now needs a MilterManagerConfiguration
	object.
	* milter/manager/milter-manager-controller.c: Include
	milter-manager-children.h.
	* test/manager/test-controller.c: Support for prural children.
	* milter/manager/milter-manager-configuration.[ch]: sending timeout ->
	writing timeout.
	* milter/manager/milter-manager-child.[ch]: Added
	milter_manager_child_new_with_timeout().
	* milter/manager/milter-manager-children.c,
	milter/manager/milter-manager-controller.c: sending timeout -> writing
	timeout.
	* test/manager/test-controller.c: Set client_ready and client_reaped
	TRUE in the head of run_spawn().
	* milter/manager/milter-manager-children.c: Emit each reply signals
	till after all child's signals are received.
	* milter/manager/milter-manager-childre.c:  Emit "error" signal with
	correct object.

2008-10-24  Kouhei Sutou  <kou@cozmixng.org>

	* milter/manager/milter-manager-controller.c,
	test/manager/test-controller.c: support body command.

	* milter/manager/milter-manager-controller.c,
	test/manager/test-controller.c: support end-of-header command.

	* ./: support coverage.

	* milter/manager/milter-manager-controller.c,
	test/lib/milter-test-client.rb, test/manager/test-controller.c:
	support header command.

	* milter/manager/milter-manager-controller.c,
	test/manager/test-controller.c: support data command.

	* milter/manager/Makefile.am: add missing milter-manager-controller.h.

	* milter/manager/milter-manager-controller.c: child -> children.

	* milter/, bindings/src/, module/configuration/ruby/:
	MILTER_MANAGER_TYPE_XXX -> MILTER_TYPE_MANAGER_XXX.

	* binding/ruby/lib/milter/manager.rb,
	binding/ruby/src/rb-milter-manager-configuration.c,
	binding/ruby/src/rb-milter-manager-child.c,
	binding/ruby/src/rb-milter-manager-private.h,
	binding/ruby/src/rb-milter-manager.c: child milter -> child.

	* TODO: add: MilterManagerMother

2008-10-24  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* milter/manager/milter-manager-child-milter.c: Use g_spawn_close_pid.
	* test/manager/test-child-milter.c: Exit error test.
	* milter/manager/milter-manager-controller.c: negotiate_reply signal
	has a MilterMacrosRequests.
	* milter/manager/milter-manager-controller.c: Merge
	MilterMacrosRequest in negotiate-reply signal.
	* milter/manager/milter-manager-controller.c: NULL check barrier for
	MilterMacrosRequests.
	* milter/manager/*: MilterManagerChildMilter -> MilterManagerChild.
	* milter/manager/milter-manager-children.[ch]: Added.
	* milter/manager/milter-manager-children.c: MilterManagerChildren now
	uses MilterReplySignals.
	* milter/manager/milter-manager-children.[ch]: Added server_context
	methods.
	* milter/manager/milter-manager-children.c: Emit each reply signals
	depends on conditions. TODO: bunch each child signals.
	* milter/manager/milter-manager-configuration.[ch],
	milter/manager/milter-manager-controller.[ch]: Use
	MilterManagerChildren. test_data() fails yet.

2008-10-23  Kouhei Sutou  <kou@cozmixng.org>

	* test/manager/test-controller.c: follow the below changes.

	* milter/manager/milter-manager.c: create controller for each session.

	* milter/manager/milter-manager-configuration.[ch]: add dummy
	create function.

	* milter/manager/milter-manager-controller.[ch]: accept client context.

2008-10-23  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* milter/manager/milter-manager-child-milter.[ch]: Emit errors when
	child milter produces a core dump or exits.

2008-10-23  Kouhei Sutou  <kou@cozmixng.org>

	* module/configuration/ruby/milter-manager-ruby-configuration.c:
	set methods.

	* milter/manager/, test/manager/:
	milter_manager_configuration_new() accepts properties.

	* milter/manager/milter-manager-controller.[ch]: follow up the
	below changes.

	* milter/, module/, test/: ruby controller -> ruby configuration.

	* module/: controller -> configuration.

	* test/lib/milter-test-client.rb: fix timeout timing.

2008-10-22  Kouhei Sutou  <kou@cozmixng.org>

	* module/controller/ruby/milter-manager-ruby-controller.c,
	test/manager/test-controller.c: set timeout but problems still exist.

	* test/lib/milter-test-client.rb (MilterTestClient#invalid_state):
	fix argument.

	* module/controller/ruby/milter-manager-ruby-controller.c,
	test/manager/test-controller.c: handle envelope-receipt.

	* module/controller/ruby/milter-manager-ruby-controller.c,
	test/manager/test-controller.c: handle envelope-from.

	* module/controller/ruby/milter-manager-ruby-controller.c,
	test/manager/test-controller.c: handle helo.

	* module/controller/ruby/milter-manager-ruby-controller.c,
	test/manager/test-controller.c: handle connect.

	* test/manager/test-child-milter.c (test_start): output nothing.

	* test/manager/test-controller.c, test/lib/milter-test-client.rb,
	module/controller/ruby/milter-manager-ruby-controller.c,
	milter/manager/milter-manager.c: write test that uses
	milter-test-client.rb.

	* test/lib/milter-test-client.rb: add.

2008-10-22  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* milter/manager/milter-manager-child-milter.c: Use
	milter_utils_set_error_with_sub_error().
	* milter/manager/milter-manager.c,
	milter/manager/milter-manager-controller.[ch],
	module/controller/ruby/milter-manager-ruby-controller.c: Handle
	"mta-timeout" signal from MilterClientContext.

2008-10-21  Kouhei Sutou  <kou@cozmixng.org>

	* milter/manager/milter-manager-child-milter.c: don't use
	g_set_error_literal().

	* test/: setup controller's test environment.

2008-10-21  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* milter/manager/milter-manager-child-milter.[ch]: Added
	milter_manager_child_milter_start().
	* milter/manager/milter-manager-child-milter.c: Do not use
	G_SPAWN_DO_NOT_REAP_CHILD since MilterManagerChildMilter does not care
	about the child process future.
	* milter/manager/milter-manager-child-milter.c: Added command line
	options.
	* test/manager/test-configuration.c: gcut_assert_equal_child_milters
	-> milter_assert_equal_child_milters.
	* milter/manager/milter-manager-child-milter.c:
	milter_manager_child_milter_start() returns GError.
	* module/controller/ruby/milter-manager-ruby-controller.c: start child
	milter process if connection fails.
	* milter/manager/milter-manager-child-milter.c: Added user and
	group. Cleanup.
	* milter/manager/milter-manager-child-milter.[ch]: Set uid and gid.
	* milter/manager/milter-manager-child-milter.[ch]: Added
	MILTER_MANAGER_CHILD_MILTER_ERROR_NO_PREVILEGE_MODE.
	* milter/manager/milter-manager-child-milter.c: Check command value.
	* milter/manager/milter-manager-child-milter.c: Use properties.
	* milter/manager/milter-manager-configuration.[ch]: Added
	milter_manager_configuration_is_privilege_mode.
	* module/controller/ruby/milter-manager-ruby-contoroller.c: Use
	milter_manager_configuration_is_privilege_mode.
	* milter/manager/milter-manager-configuration.[ch]: Added
	milter_manager_configuration_get_return_status_if_filter_unavailable.
	* module/controller/ruby/milter-manager-ruby-contoroller.c: Use
	milter_manager_configuration_get_return_status_if_filter_unavailable.
	* milter/manager/milter-manager-configuration.[ch]: Added
	get_XX_timeout().
	* milter/manager/milter-manager.c (setup_context_signals): gpointer ->
	MilterManagerContoroller.

2008-10-20  Kouhei Sutou  <kou@cozmixng.org>

	* test/lib/milter-test-server.rb: make customizable.

	* test/lib/milter-test-server.rb: add a milter server implemented
	by Ruby for testing milter manager.

	* test/manager/: move to test here.

	* test/lib/: milter-test-utils -> milter-manager-test-utils.

2008-10-16  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* module/controller/ruby/milter-manager-ruby-controller.c:
	"negotiate-reply" signal accompanies with GList not GHashTable.

2008-10-15  Kouhei Sutou  <kou@cozmixng.org>

	* module/controller/ruby/milter-manager-ruby-controller.c:
	negotiate -> negotiate-reply.

	* ./: close -> quit.

2008-10-15  Hiroyuki Ikezoe  <poincare@ikezoe.net>

	* milter/manager/milter-manager.c: Connect to "connection-established"
	instead of MilterClientContextSetupFunc.

2008-10-10  Kouhei Sutou  <kou@cozmixng.org>

	* module/controller/ruby/milter-manager-ruby-controller.c: add
	experimental server side handling. MilterServerContext should emit
	negotiate-response signal.

	* data/milter-manager.conf: use spec.

	* binding/ruby/lib/milter/manager.rb: support connection_spec.

	* milter/module/milter-manager-controller.[ch],
	module/controller/ruby/milter-manager-ruby-controller.c,
	binding/ruby/lib/milter/manager.rb,
	milter/manager/milter-manager.c:
	- search a configure file in load paths.
	- use status returned by controller.

	* configure.ac, Makefile.am, data/Makefile.am,
	data/milter-manager.conf: add sample configuration file.

	* binding/ruby/src/: bind some methods for
	MilterManagerConfiguration and MilterManagerChildMilter.

	* binding/ruby/lib/milter/manager.rb: support child milter define
	API.

	* milter/manager/milter-manager-child-milter.[ch]: accept name.

	* milter/manager/milter-manager.c: show log to stdout.

	* milter/manager/milter-manager-ruby-internal.h: support rb_errinfo().

	* module/controller/ruby/Makefile.am: support milter_logger().

	* module/controller/ruby/milter-manager-ruby-controller.c: guard
	error on Ruby.

	* milter/manager/milter-manager-context.[ch]: remove.
	* milter/manager/milter-manager.c: use MiliterManagerController
	directly.

	* milter/manage/milter-manager-controller.[ch],
	module/controller/ruby/milter-manager-ruby-controller.c: load()
	receives file name.

2008-10-09  Kouhei Sutou  <kou@cozmixng.org>

	* milter/manager/milter-manager.c: handle SIGINT.

	* module/controller/: create.

	* module/ruby/: move to ...
	* module/controller/ruby/: ... here.

	* configure.ac, module/ruby/milter-manager-ruby-controller.c,
	binding/ruby/: set Ruby related paths.

	* configure.ac, module/manager/milter-manager-controller.c: set
	module related path.

	* module/ruby/Makefile.am: remove needless variable.

	* module/ruby/Makefile.am: fix rpath.

	* milter/: add module based controller.
	* module/: implement Ruby based controller module.
	* binding/: build as extension library.
	* src/: split milter-manger program.

2008-10-08  Kouhei Sutou  <kou@cozmixng.org>

	* milter/manager/, binding/: support configuration file load
	written by Ruby but there are many problems...

	* milter/manager/, test/: MilterManagerConfiguration collects
	MilterManagerChildMilter.

2008-10-07  Kouhei Sutou  <kou@cozmixng.org>

	* milter/manager/: make MilterManagerConfiguration GObject.

	* configure.ac, milter/: support Ruby embedding.

	* ./: move milter/{core,client,server} and libmilter to
	milter-toolkit package.
